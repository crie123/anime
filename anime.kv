#:kivy 2.0.0

<Label>:
    color: app.text_color
    font_name: 'Verdana'
    font_size: '14sp'

<TextInput>:
    background_color: app.input_bg_color
    foreground_color: app.text_color
    cursor_color: app.primary_color
    multiline: False
    padding: [10, 10]
    font_name: 'Arial'
    font_size: '13sp'
    canvas.before:
        Color:
            rgba: app.primary_color
        Rectangle:
            pos: self.pos
            size: [self.size[0], 1]
        Rectangle:
            pos: [self.pos[0], self.pos[1] + self.size[1] - 1]
            size: [self.size[0], 1]
        Rectangle:
            pos: self.pos
            size: [1, self.size[1]]
        Rectangle:
            pos: [self.pos[0] + self.size[0] - 1, self.pos[1]]
            size: [1, self.size[1]]

<Spinner>:
    background_normal: ''
    background_color: app.primary_color
    color: app.secondary_color
    option_cls: "SpinnerOption"
    font_name: 'Arial'
    font_size: '13sp'

<SpinnerOption>:
    background_normal: ''
    background_color: app.primary_color
    color: app.secondary_color
    font_name: 'Arial'
    font_size: '13sp'

<Button>:
    background_normal: ''
    background_color: app.primary_color
    color: app.secondary_color
    size_hint_y: None
    height: 40
    font_name: 'Arial'
    font_size: '13sp'
    bold: True
    canvas.before:
        Color:
            rgba: (0.18, 0.54, 0.81, 1) if self.state == 'normal' else (0.15, 0.45, 0.68, 1)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [8]

<Popup>:
    background: ''
    background_color: app.bg_color
    title_color: app.text_color
    separator_color: app.primary_color
    title_size: '18sp'

<AnimeCard>:
    canvas.before:
        Color:
            rgba: app.secondary_color
        Rectangle:
            pos: self.pos
            size: self.size
    orientation: 'vertical'
    size_hint_y: None
    height: 320
    padding: 10
    spacing: 8

    Image:
        id: poster
        source: ''
        allow_stretch: True
        keep_ratio: True
        size_hint_y: None
        height: 240

    Label:
        id: title_label
        text: ''
        size_hint_y: None
        height: 35
        color: app.text_color
        font_name: 'Arial'
        font_size: '14sp'
        bold: True

    Label:
        id: tags_label
        text: ''
        size_hint_y: None
        height: 25
        font_size: '11sp'
        color: (0.8, 0.8, 0.8, 1)
        font_name: 'Verdana'

<FileChooserPopup>:
    title: 'Choose File'
    size_hint: .9, .9
    auto_dismiss: False
    BoxLayout:
        orientation: 'vertical'
        spacing: 8
        padding: 8

        FileChooserListView:
            id: filechooser

        TextInput:
            id: filename_input
            hint_text: 'Filename (for save)'
            size_hint_y: None
            height: 40

        BoxLayout:
            size_hint_y: None
            height: 40
            spacing: 8
            Button:
                text: 'Select'
                on_release: root._select_file()
            Button:
                text: 'Cancel'
                on_release: root.dismiss()

<ExportPopup>:
    BoxLayout:
        orientation: 'vertical'
        spacing: 10
        padding: 10
        Button:
            id: export_button
            text: app.str_export_to_json
            size_hint_y: None
            height: 40
            on_press: root.export_json(self)
        Button:
            id: close_button
            text: app.str_close
            size_hint_y: None
            height: 40
            on_press: root.close_popup(self)

<ImportPopup>:
    BoxLayout:
        orientation: 'vertical'
        spacing: 10
        padding: 10
        Button:
            id: import_button
            text: app.str_import_from_json
            size_hint_y: None
            height: 40
            on_press: root.import_json(self)
        Button:
            id: close_button
            text: app.str_close
            size_hint_y: None
            height: 40
            on_press: root.close_popup(self)

<TagFilterPopup>:
    BoxLayout:
        orientation: 'vertical'
        spacing: 10
        padding: 10
        ScrollView:
            do_scroll_x: False
            BoxLayout:
                id: tags_box
                orientation: 'vertical'
                size_hint_y: None
                height: self.minimum_height
        BoxLayout:
            size_hint_y: None
            height: 40
            spacing: 10
            Button:
                text: app.str_apply
                on_release: root.apply_filters()
            Button:
                text: app.str_cancel
                on_release: root.close_popup()

<DetailPopup>:
    size_hint: .9, .9
    auto_dismiss: True
    BoxLayout:
        orientation: 'vertical'
        spacing: 12
        padding: 15
        BoxLayout:
            size_hint_y: None
            height: 40
            Label:
                id: detail_title
                text: ''
                font_name: 'Arial'
                font_size: '18sp'
                bold: True
                color: app.text_color
            Button:
                text: 'X'
                size_hint_x: None
                width: 40
                on_release: root.dismiss()
        Image:
            id: detail_poster
            source: ''
            size_hint_y: None
            height: 360
            allow_stretch: True
            keep_ratio: True
        Carousel:
            id: detail_carousel
            direction: 'right'
            size_hint_y: None
            height: 240
            spacing: 5
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: 160
            spacing: 10
            Label:
                id: detail_tags
                text: ''
                size_hint_y: None
                height: 25
                font_name: 'Verdana'
                font_size: '12sp'
                color: (0.8, 0.8, 0.8, 1)
            ScrollView:
                do_scroll_x: False
                Label:
                    id: detail_description
                    text: ''
                    size_hint_y: None
                    text_size: self.width, None
                    height: self.texture_size[1]
                    font_name: 'Verdana'
                    font_size: '12sp'
                    padding: [10, 10]
                    color: app.text_color
            BoxLayout:
                size_hint_y: None
                height: 40
                spacing: 10
                Button:
                    text: 'Edit'
                    on_release: root.on_edit()
                Button:
                    text: 'Delete'
                    on_release: root.on_delete()

<MainScreen>:
    canvas.before:
        Color:
            rgba: app.bg_color
        Rectangle:
            pos: self.pos
            size: self.size

    BoxLayout:
        orientation: 'vertical'
        spacing: 10
        padding: 10

        # Custom title bar
        BoxLayout:
            size_hint_y: None
            height: 40
            spacing: 10
            canvas.before:
                Color:
                    rgba: app.secondary_color
                Rectangle:
                    pos: self.pos
                    size: self.size
            
            DraggableTitleBar:
                size_hint_x: 0.5

            Label:
                text: 'Anime Collection'
                size_hint_x: None
                width: 200
                color: app.text_color
                font_name: 'Arial'
                font_size: '16sp'
                bold: True
            
            DraggableTitleBar:
                size_hint_x: 0.35

            Button:
                id: lang_btn
                text: 'EN' if app.current_language == 'ru' else 'РУ'
                size_hint_x: None
                width: 50
                background_color: app.primary_color
                on_press: app.toggle_language()

            Button:
                id: theme_btn
                text: 'MOON' if app.is_dark_theme else 'SUN'
                size_hint_x: None
                width: 50
                background_color: app.primary_color
                on_press: app.toggle_theme()

            Button:
                text: 'X'
                size_hint_x: None
                width: 40
                background_color: app.accent_color
                on_press: app.stop()

        # Controls bar
        BoxLayout:
            size_hint_y: None
            height: 60
            spacing: 15
            padding: [20, 5]
            canvas.before:
                Color:
                    rgba: app.secondary_color
                Rectangle:
                    pos: self.pos
                    size: self.size

            TextInput:
                id: search_input
                hint_text: app.str_search
                size_hint_x: 0.25
                on_text: root.on_search_text(self, self.text)

            Spinner:
                id: anime_spinner
                text: app.str_select_anime
                values: [app.str_select_anime]
                size_hint_x: 0.2
                on_text: root.on_spinner_select(self, self.text)

            Button:
                id: tag_multi_btn
                text: app.str_tags
                size_hint_x: 0.27
                on_press: root.open_tag_filter(self)

            Spinner:
                id: sort_spinner
                text: app.str_sort
                values: [app.str_a_z, app.str_z_a, app.str_date_added]
                size_hint_x: 0.15
                on_text: root.on_sort_select(self, self.text)

            Button:
                text: app.str_add
                size_hint_x: 0.08
                on_press: root.add_anime(self)

            Button:
                text: app.str_edit
                size_hint_x: 0.08
                on_press: root.edit_anime(self)

            Button:
                text: app.str_import
                size_hint_x: 0.12
                on_press: root.import_data(self)

            Button:
                text: app.str_export
                size_hint_x: 0.12
                on_press: root.export_data(self)

        # Content area
        BoxLayout:
            orientation: 'horizontal'
            spacing: 20
            padding: [10, 0]

            # Scrollable grid for anime cards
            ScrollView:
                size_hint_x: 0.7
                do_scroll_x: False
                canvas.before:
                    Color:
                        rgba: app.secondary_color
                    Rectangle:
                        pos: self.pos
                        size: self.size
                
                GridLayout:
                    id: grid_layout
                    cols: 3
                    spacing: 15
                    padding: 10
                    size_hint_y: None
                    height: self.minimum_height

            # Details panel
            BoxLayout:
                orientation: 'vertical'
                size_hint_x: 0.3
                spacing: 15
                padding: 15
                canvas.before:
                    Color:
                        rgba: app.secondary_color
                    Rectangle:
                        pos: self.pos
                        size: self.size

                Image:
                    id: current_poster
                    source: ''
                    size_hint_y: 0.4
                    allow_stretch: True
                    keep_ratio: True

                Label:
                    id: current_title
                    text: 'Select an anime'
                    size_hint_y: None
                    height: 50
                    color: app.text_color
                    font_name: 'Arial'
                    font_size: '16sp'
                    bold: True

                Label:
                    id: current_tags
                    text: ''
                    size_hint_y: None
                    height: 35
                    color: (0.8, 0.8, 0.8, 1)
                    font_name: 'Verdana'
                    font_size: '12sp'

                ScrollView:
                    size_hint_y: 0.3
                    do_scroll_x: False
                    
                    Label:
                        id: current_description
                        text: ''
                        size_hint_y: None
                        height: self.texture_size[1]
                        text_size: self.width, None
                        padding: [10, 10]
                        color: app.text_color
                        font_name: 'Verdana'
                        font_size: '11sp'

                Carousel:
                    id: screenshots_carousel
                    direction: 'right'
                    size_hint_y: 0.2
                    spacing: 3

                Button:
                    text: app.str_delete_button
                    size_hint_y: None
                    height: 40
                    background_color: app.accent_color
                    on_press: root.delete_anime(self)

<AddAnimePopup>:
    title_input: title_input
    description_input: description_input
    poster_input: poster_input
    screenshots_input: screenshots_input
    tags_input: tags_input

    BoxLayout:
        orientation: 'vertical'
        spacing: 15
        padding: 20

        Label:
            text: app.str_add_new_anime
            size_hint_y: None
            height: 40
            font_size: '22sp'
            bold: True
            font_name: 'Arial'
            color: app.text_color

        GridLayout:
            cols: 1
            spacing: 12
            size_hint_y: 0.9

            BoxLayout:
                size_hint_y: None
                height: 40
                spacing: 15
                
                Label:
                    text: app.str_title
                    size_hint_x: 0.15
                    font_name: 'Arial'
                    font_size: '13sp'
                    bold: True
                
                TextInput:
                    id: title_input
                    hint_text: app.str_enter_anime_title
                    size_hint_x: 0.85
                    multiline: False

            BoxLayout:
                size_hint_y: None
                height: 40
                spacing: 15
                
                Label:
                    text: app.str_poster
                    size_hint_x: 0.15
                    font_name: 'Arial'
                    font_size: '13sp'
                    bold: True
                
                TextInput:
                    id: poster_input
                    hint_text: app.str_enter_poster_path
                    size_hint_x: 0.65
                    multiline: False
                
                Button:
                    text: app.str_browse
                    size_hint_x: 0.2
                    on_press: root.select_poster(self)

            BoxLayout:
                size_hint_y: None
                height: 40
                spacing: 15
                
                Label:
                    text: app.str_screenshots
                    size_hint_x: 0.15
                    font_name: 'Arial'
                    font_size: '13sp'
                    bold: True
                
                TextInput:
                    id: screenshots_input
                    hint_text: app.str_enter_screenshot_paths
                    size_hint_x: 0.65
                    multiline: False

                Button:
                    text: app.str_browse
                    size_hint_x: 0.2
                    on_press: root.select_screenshots(self)

            BoxLayout:
                size_hint_y: None
                height: 40
                spacing: 15
                
                Label:
                    text: app.str_tags_label
                    size_hint_x: 0.15
                    font_name: 'Arial'
                    font_size: '13sp'
                    bold: True

                TextInput:
                    id: tags_input
                    hint_text: app.str_enter_tags_input
                    size_hint_x: 0.85
                    multiline: False

            BoxLayout:
                orientation: 'vertical'
                spacing: 12
                
                Label:
                    text: app.str_description
                    size_hint_y: None
                    height: 30
                    halign: 'left'
                    font_name: 'Arial'
                    font_size: '13sp'
                    bold: True
                
                TextInput:
                    id: description_input
                    hint_text: app.str_enter_anime_description
                    multiline: True
                    size_hint_y: 1

        BoxLayout:
            size_hint_y: None
            height: 50
            spacing: 20
            padding: [40, 0]

            Button:
                text: app.str_save
                size_hint_x: 0.5
                on_press: root.save_anime(self)

            Button:
                text: app.str_cancel
                size_hint_x: 0.5
                on_press: root.close_popup()

<EditAnimePopup>:
    title_input: title_input
    description_input: description_input
    poster_input: poster_input
    screenshots_input: screenshots_input
    tags_input: tags_input

    BoxLayout:
        orientation: 'vertical'
        spacing: 15
        padding: 20

        Label:
            text: app.str_edit_anime
            size_hint_y: None
            height: 40
            font_size: '22sp'
            bold: True
            font_name: 'Arial'
            color: app.text_color

        GridLayout:
            cols: 1
            spacing: 12
            size_hint_y: 0.9

            BoxLayout:
                size_hint_y: None
                height: 40
                spacing: 15
                
                Label:
                    text: app.str_title
                    size_hint_x: 0.15
                    font_name: 'Arial'
                    font_size: '13sp'
                    bold: True
                
                TextInput:
                    id: title_input
                    hint_text: app.str_enter_anime_title
                    size_hint_x: 0.85
                    multiline: False

            BoxLayout:
                size_hint_y: None
                height: 40
                spacing: 15
                
                Label:
                    text: app.str_poster
                    size_hint_x: 0.15
                    font_name: 'Arial'
                    font_size: '13sp'
                    bold: True
                
                TextInput:
                    id: poster_input
                    hint_text: app.str_enter_poster_path
                    size_hint_x: 0.65
                    multiline: False
                
                Button:
                    text: app.str_browse
                    size_hint_x: 0.2
                    on_press: root.select_poster(self)

            BoxLayout:
                size_hint_y: None
                height: 40
                spacing: 15
                
                Label:
                    text: app.str_screenshots
                    size_hint_x: 0.15
                    font_name: 'Arial'
                    font_size: '13sp'
                    bold: True
                
                TextInput:
                    id: screenshots_input
                    hint_text: app.str_enter_screenshot_paths
                    size_hint_x: 0.65
                    multiline: False

                Button:
                    text: app.str_browse
                    size_hint_x: 0.2
                    on_press: root.select_screenshots(self)

            BoxLayout:
                size_hint_y: None
                height: 40
                spacing: 15
                
                Label:
                    text: app.str_tags_label
                    size_hint_x: 0.15
                    font_name: 'Arial'
                    font_size: '13sp'
                    bold: True

                TextInput:
                    id: tags_input
                    hint_text: app.str_enter_tags_input
                    size_hint_x: 0.85
                    multiline: False

            BoxLayout:
                orientation: 'vertical'
                spacing: 12
                
                Label:
                    text: app.str_description
                    size_hint_y: None
                    height: 30
                    halign: 'left'
                    font_name: 'Arial'
                    font_size: '13sp'
                    bold: True
                
                TextInput:
                    id: description_input
                    hint_text: app.str_enter_anime_description
                    multiline: True
                    size_hint_y: 1

        BoxLayout:
            size_hint_y: None
            height: 50
            spacing: 20
            padding: [40, 0]

            Button:
                text: app.str_save
                size_hint_x: 0.5
                on_press: root.save_anime(self)

            Button:
                text: app.str_cancel
                size_hint_x: 0.5
                on_press: root.close_popup()